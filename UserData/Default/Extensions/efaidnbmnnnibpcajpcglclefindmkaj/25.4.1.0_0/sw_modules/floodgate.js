/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{common as e}from"./common.js";import{Proxy as t}from"./proxy.js";import{CACHE_PURGE_SCHEME as s,ADOBE_INTERNAL as r,EXPRESS as o,EXPERIMENT_VARIANTS_STORAGE_KEY as a}from"./constant.js";import{dcLocalStorage as n}from"../common/local-storage.js";import{util as i}from"./util.js";import{forceResetService as l}from"./force-reset-service.js";import{OFFSCREEN_DOCUMENT_PATH as c}from"../common/constant.js";import{loggingApi as h}from"../common/loggingApi.js";import{analytics as u}from"../common/analytics.js";import{toggleExpressTouchpoints as g}from"./express.js";import{registerUninstallUrl as m}from"../common/util.js";import{checkForImsSidCookie as f}from"./api-util.js";var d=null;class p{proxy(...e){return t.proxy.bind(this)(...e)}registerExperimentVariantChangeListener(){chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&Object.entries(e).forEach((([e])=>{e===a&&m()}))}))}init(){this.clientId=e.getViewerIMSClientId(),this.floodgateUri=e.getFloodgateuri(),this.env=e.getEnv(),this.accessToken=null,this.useAnonymousUUID=!0,this.anonUserUUID=null,this.featureGroups=null,this.featuresMeta={},this.lastCallTime=0,this.callInProgress=!1,this.callPromise=null,this.adobeInternalTTL=9e5,this.adobeExternalTTL=432e5,this.ffResponse=null,this.registerExperimentVariantChangeListener()}getReleaseVariant(e,t){return this.getReleaseVariants(e,t).then((e=>{if(Array.isArray(e)&&e.length>0)return e[0]}))}getReleaseVariants(e,t){return this.getFeatureGroups(t).then((t=>{const s=[e,`${e}-cohort`,`${e}-internal`,`${e}-external`].find((e=>Object.keys(t).includes(e)));if(s)return t[s]}))}async getFeaturesAndGroups(e){try{const t=await this.getFeatureGroups(e);let s=[].concat(...Object.values(t));return s=this.updateLocalFeatureFlags(s),{featureFlags:s,featureGroups:t,ffResponse:this.ffResponse}}catch(e){return{featureFlags:[],featureGroups:{}}}}getFeatureMeta(e){return this.featuresMeta[e]||this.featuresMeta[`${e}-internal`]||this.featuresMeta[`${e}-cohort`]}hasFlag(e,t){return this.getFeaturesAndGroups(t).then((({featureFlags:t})=>t.includes(e)||t.includes(`${e}-install`)||t.includes(`${e}-internal`)||t.includes(`${e}-cohort`)||t.includes(`${e}-external`))).catch((e=>null))}getFeatureGroups(e){return this.processOteFeatureConfig(),new Promise((t=>{e===s.NO_CALL?t(this.featureGroups||{}):e!==s.EAGER&&this.featureGroups?(t(this.featureGroups),this._getFeatureGroups()):this._getFeatureGroups().then((e=>{this.setUserCohort(e),t(e)})),this.setUserCohort(this.featureGroups)}))}setAdobeInternal(e){e[r]&&e[r].length&&n.setItem("adobeInternal","true")}setUserCohort(e){n.getItem("userCohort")||e.Feature_cohorts&&e.Feature_cohorts.length&&(n.setItem("userCohort",e.Feature_cohorts[0]),u.event(`DCBrowserExt:UserCohort:Cohort:${e.Feature_cohorts[0]}`)),n.getItem("feature_cohort")||e.Feature_cohorts&&e.Feature_cohorts.length&&(n.setItem("feature_cohort",e.Feature_cohorts[0]),u.event(`DCBrowserExt:UserCohort:${e.Feature_cohorts[0]}`))}processFloodgateResponse(e){if(!e||0===Object.keys(e).length)return!1;try{const t={},s={};e.timestamp=Date.now(),e.releases.forEach((({release_name:e,features:r,meta:o})=>{t[e]=r,o.forEach((({k:e,v:t})=>{s[e]=atob(t)}))})),this.ffResponse=e,this.featureGroups=t,this.featuresMeta=s,this.lastCallTime=Date.now(),n.setItem("fgLastCallTimestamp",this.lastCallTime),this.setAdobeInternal(t);const r=e.userId?`ffResponse_${e.userId}`:"ffResponse_anon";n.setItem(r,JSON.stringify(e))}catch(e){return console.log("Error in processing floodgate response",e),!1}}async _getFeatureGroups(e=!1){const t=(new Date).getTime();this.fgRearch=n.getItem("fgRearch");const s="true"===n.getItem("adobeInternal"),r=s?"adobeInternalTTL":"adobeExternalTTL",o=s?this.adobeInternalTTL:this.adobeExternalTTL,a=n.getItem(r)||o;if(navigator.onLine&&(t>this.lastCallTime+a||e)){this.callInProgress||(this.callInProgress=!0,this.fgRearch?this.callPromise=this.callFloodgateAPIThroughOffscreen():this.callPromise=this.callFloodgateAPI());const e=await this.callPromise;this.callInProgress=!1,e&&(this.processFloodgateResponse(e),this.onFloodgateCallCompleted())}return this.featureGroups}floodgateForceReset(e){const t=e.timeDelay||0;setTimeout((()=>{this._getFeatureGroups(!0)}),t)}processOteFeatureConfig(){n.getItem("fgRearch")&&(l.executeFeature("floodgate",this.floodgateForceReset.bind(this)),l.getFloodgateTTLs())}updateLocalFeatureFlags(e){const t=n.getItem("floodgate-add").split(/[, ]+/).filter((t=>!e.includes(t)));e.push(...t);const s=n.getItem("floodgate-remove").split(/[, ]+/),r=n.getItem("floodgate-rollback")?.split(/[, ]+/),o=new Set([...s,...r]);return e=e.filter((e=>!o.has(e)))}getQueryParams(){const e="true"===n.getItem("betaOptOut"),t="true"===n.getItem("adobeInternal"),s=n.getItem("pdfViewer");let r,o=n.getItem("lastUserGuid"),a=n.getItem("userCohort"),l=n.getItem("feature_cohort");o&&""!==o||(o=this.anonUserUUID),r=s?"true"===s?"enabled":"disabled":"neverEnabled";const c={clientId:this.clientId,meta:!0,extVersion:chrome.runtime.getManifest().version,extId:chrome.runtime.id,installType:n.getItem("installType"),installVersion:n.getItem("installVersion"),adbInt:!e&&t,extbrowser:i.isEdge()?"edge":"chrome",viewerStatus:r,anonId:o,FCohorts:a,featureCohort:l};return n.getItem("lvt")&&(c.flag1=n.getItem("lvt")),n.getItem("gvt")&&(c.flag2=n.getItem("gvt")),n.setItem("fgContextVars",c),c}handleViewerFloodgateResponse(e){this.processFloodgateResponse(e),this.getQueryParams()}getApiUrl(){const e=new URL(`${this.floodgateUri}/v3/feature`),t=this.getQueryParams();if(Object.entries(t).forEach((([t,s])=>{e.searchParams.append(t,s)})),!this.floodgateUri||!this.clientId)throw new Error("missing data");return e.href}logFloodgateCallStacktrace(){const e=n.getItem("fgStackTractLogStartTime");e||n.setItem("fgStackTractLogStartTime",(new Date).getTime());if((new Date).getTime()-e<=6048e5){const e=(new Error).stack;h.info({message:"Floodgate API call stacktrace",stackTrace:e})}}callFloodgateAPI(){const t=this.accessToken?`Bearer ${this.accessToken}`:"",s={"x-api-key":this.clientId};if(this.useAnonymousUUID){try{this.anonUserUUID=n.getItem("anonUserUUID")}catch(e){}this.anonUserUUID?s["x-adobe-uuid"]=this.anonUserUUID:t?s.Authorization=t:(this.anonUserUUID=e.createAnonUserUUID(),s["x-adobe-uuid"]=this.anonUserUUID)}else t&&(s.Authorization=t);return this.logFloodgateCallStacktrace(),fetch(this.getApiUrl(),{method:"GET",headers:s}).then((e=>{const t=e.headers.get("content-type");if(e.ok&&t&&t.includes("application/json"))return this.error=void 0,e.json();e.text().then((s=>{const r=`Floodgate API failed with status ${e.status} ${e.statusText} type ${t} text ${s}`;throw new TypeError(r)}))})).catch((e=>{this.error=e&&e.message?e:new Error(`Floodgate failure: ${JSON.stringify(e)}`)}))}async callFloodgateAPIThroughOffscreen(){const t=this.getQueryParams();this.anonUserUUID=this.anonUserUUID||n.getItem("anonUserUUID")||e.createAnonUserUUID();const r=await f(),o=await this.hasFlag("dc-cv-fg-loadImsLib",s.NO_CALL),a={main_op:"callFloodgateAPI",target:"offscreen",fgContextVars:t,anonUserUUID:this.anonUserUUID,iframeURL:e.getFloodgateUrl(),ims_sid_cookie_available:r,loadImsLib:o},l=`${c}?env=${e.getEnv()}`;return await i.setupOffscreenDocument({path:l,reasons:[chrome.offscreen.Reason.IFRAME_SCRIPTING],justification:"Load iframe in offscreen document"}),new Promise((e=>{setTimeout((async()=>{const t=await chrome.runtime.sendMessage(a);if(t&&t.response)try{const s=JSON.parse(t.response.fgApiResponse);s.isSignedIn=t.response.isSignedIn,s.userId=t.response.userId,e(s)}catch(t){e(null)}else{const t=n.getItem("ffResponse_anon");e(t?JSON.parse(t):null)}}),50)}))}onFloodgateCallCompleted(){g()}}function I(){const e=Object.entries(n.getAllItems()).filter((([e,t])=>e.startsWith("ffResponse_")&&"ffResponse_anon"!==e)).map((([e,t])=>({key:e,timestamp:JSON.parse(n.getItem(e)).timestamp})));if(e.length>5){e.sort(((e,t)=>t.timestamp-e.timestamp)).slice(5).forEach((({key:e})=>{n.removeItem(e)}))}}setInterval(I,864e5),I(),d||(d=new p).init();export const floodgate=d;