/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class AttributionManager{constructor(){if(AttributionManager.instance)return AttributionManager.instance;AttributionManager.instance=this,this.highlight=new Highlight;const t=document.createElement("style");t.innerHTML="\n            @media (prefers-color-scheme: dark) {\n                ::highlight(search-results) {\n                    background-color: #5258E4;\n                    color: white;\n                }\n            }\n\n            @media (prefers-color-scheme: light) {\n                ::highlight(search-results) {\n                    background-color: #D3D5FF;\n                    color: black;\n                }\n            }\n        ",document.head.appendChild(t)}getNodeFromXPath(t){return(new XPathEvaluator).evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}isRangeVisible(t){const e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return!1;let n=t.startContainer.nodeType===Node.ELEMENT_NODE?t.startContainer:t.startContainer.parentElement;for(;n;){if("0"===window.getComputedStyle(n).opacity)return!1;n=n.parentElement}return!0}logAttributionSuccessPercentage(t="",e=""){try{let n=0;if(t&&e){const o=t.match(/"[^"]+"|[\w]+/g)||[],r=e.match(/"[^"]+"|[\w]+/g)||[],i=o.length,a=r.length;if(i&&a){const t=Array(i+1).fill(null).map((()=>Array(a+1).fill(0)));for(let e=1;e<=i;e++)for(let n=1;n<=a;n++)o[e-1]===r[n-1]?t[e][n]=t[e-1][n-1]+1:t[e][n]=Math.max(t[e-1][n],t[e][n-1]);const e=t[i][a];n=(e/Math.max(i,a)*100).toFixed(2)}}chrome.runtime.sendMessage({main_op:"log-info",log:{message:"[Attribution Info]: Matching percentage of X path content and bound content",contentMatchPercentage:n,xPathContent:t,boundContent:e}})}catch(t){chrome.runtime.sendMessage({main_op:"log-error",log:{message:"Error in calculating matching percentage of X path content and bound content",error:t.toString()}})}}highlightTextNode(t,e,n,o,r){const i=this.getNodeFromXPath(t),a=this.getNodeFromXPath(e);if(!i)throw new Error("Node not found for startNodeXpath: "+t);if(!a)throw new Error("Node not found for endNodeXPath: "+e);if(i.nodeType!==Node.TEXT_NODE)throw new Error("Start node is not a text node: "+t);if(a.nodeType!==Node.TEXT_NODE)throw new Error("End node is not a text node: "+e);const h=document.createRange();if(h.setStart(i,n),h.setEnd(a,o),this.logAttributionSuccessPercentage(h.toString(),r),this.highlight.add(h),CSS.highlights.set("search-results",this.highlight),!this.isRangeVisible(h))throw new Error(`Range is not visible. startNodeXpath: ${t}, endNodeXPath: ${e}`);i.parentElement?.scrollIntoView({behavior:"smooth",block:"center"})}removeHighlights(){util.consoleLog("Removing highlights"),this.highlight.clear()}highlightText(t){this.removeHighlights(),util.consoleLog("Highlighting text: ",t);const{source:{bounds:e}}=t;for(const t of e){const{text:e,start_offset:n,end_offset:o,start_xpath:r,end_xpath:i,startOffsetInOriginal:a,endOffsetInOriginal:h}=t;try{this.highlightTextNode(r,i,a||n,h||o,e)}catch(t){chrome.runtime.sendMessage({main_op:"log-error",log:{message:"Error in Highlighting Attribution",error:t.toString(),url:window.location.href,text:e}})}e||chrome.runtime.sendMessage({main_op:"log-error",log:{message:"Error in Highlighting Attribution",start_xpath:r,end_xpath:i,startOffsetInOriginal:a,endOffsetInOriginal:h,error:"Attribution Text is empty"}})}}}