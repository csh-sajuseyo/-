/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{signInUtil as e}from"../../browser/js/viewer/signInUtils.js";import{dcLocalStorage as t}from"../../common/local-storage.js";import{upsellService as s}from"./upsellService.js";import{getContentLocale as a}from"./sidePanelUtil.js";import{util as i}from"../../browser/js/content-util.js";await t.init();const o=t.getItem("touchpoint");t.removeItem("touchpoint");const n=e=>{t.setItem("touchpoint",e),window.location.reload()};window.onbeforeunload=()=>{chrome.tabs.sendMessage(r.tabId,{main_op:"removeHighlights"})},window.addEventListener("message",(a=>{if(a.origin===r.origin)switch(a.data.main_op){case"preferences":chrome.runtime.openOptionsPage();break;case"highlightText":case"removeHighlights":chrome.tabs.sendMessage(r.tabId,{...a.data});break;case"cdnReady":r.isCdnReadyResolver();break;case"reloadAll":chrome.runtime.sendMessage({main_op:"reload",touchpoint:a.data.touchpoint}),n(a.data.touchpoint);break;case"reload":n(a.data.touchpoint);break;case"signIn":e.sidePanelSignIn(r.tabId);break;case"subscribeNow":t.removeItem("upsellFromAnon"),s.clickSubscribeNow(),t.setItem("upsellFromAnon",a.data.isAnonUpsell);break;case"saveVisitorID":if(a.data.visitorID){const e=t.getItem("viewerVisitorID");t.setItem("viewerVisitorID",a.data.visitorID),e&&e!==a.data.visitorID&&i.sendAnalytics("DCBrowserExt:Analytics:viewerVisitorID:MCMID:Changed")}}})),chrome.runtime.onMessage.addListener(((e,s,a)=>{if("reload"===e.main_op&&n(e.touchpoint),"reloadTab"===e.main_op&&e.tabId==r.tabId&&n(e.touchpoint),"post_upsell"===e.main_op&&e.tabId==r.tabId)return a({success:!0,message:"Upsell process completed successfully."}),r.sendMessage({type:"upsellComplete"}),t.removeItem("upsellFromAnon"),!0;"post_upsell_anon"===e.main_op&&e.tabId===r.tabId&&(t.removeItem("upsellFromAnon"),r.sendMessage({type:"upsellAnonTransition"})),"page_switched"===e.main_op&&e.tabId===r.tabId&&r.sendMessage({type:"sidepanelPageSwitch",disqualified:!e.qualified}),"chrome_viewer_opened"===e.main_op&&e.activeTabId==r.tabId&&window.close()}));const r=new class{urlParams=new URLSearchParams(window.location.search);tabId=parseInt(this.urlParams.get("tabId"));iframeElement=document.getElementById("sidepanel");constructor(){const e=new URL(t.getItem("sidepanelUrl")),s="false"!==t.getItem("logAnalytics"),a="false"!==t.getItem("ANALYTICS_OPT_IN_ADMIN");e.searchParams.append("la",s&&a),e.searchParams.append("ca",chrome.runtime.id),e.searchParams.append("cluster",t.getItem("cluster")||"beta"),this.iframeElement.src=e.href,this.origin=e.origin}isCdnReady=new Promise(((e,t)=>{const s=setTimeout((()=>{t(new Error("Hosted sidepanel loading timeout........."))}),1e4);this.isCdnReadyResolver=()=>{clearTimeout(s),e()}}));supportedOrigin=e=>{try{return!![/^https:\/\/([a-zA-Z\d-]+\.){0,}(adobe|acrobat)\.com(:[0-9]*)?$/].find((t=>t.test(e)))}catch(e){return!1}};sendMessage=e=>{this.iframeElement&&this.supportedOrigin(this.origin)&&this.isCdnReady.then((()=>this.iframeElement.contentWindow.postMessage(e,this.origin)))}},d=await chrome.tabs.sendMessage(r.tabId,{main_op:"getHtmlContent"});i.consoleLog("HTML: Response from content script: ",d);let l=d.htmlContent;const m=await a(d.textContent);r.sendMessage({type:"sidepanelHtmlContent",htmlContent:l,initialQuestion:d.initialQuestion,disqualified:d.disqualified,pageLanguage:m.language,touchpoint:o});