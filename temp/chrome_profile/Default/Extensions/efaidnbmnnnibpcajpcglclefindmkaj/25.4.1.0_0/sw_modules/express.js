/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e,events as t}from"../common/analytics.js";import{dcLocalStorage as n,dcSessionStorage as r}from"../common/local-storage.js";import{loggingApi as o}from"../common/loggingApi.js";import{CACHE_PURGE_SCHEME as s,EXPERIMENT_VARIANTS_STORAGE_KEY as a,EXPRESS as c,EXPRESS_CONTEXT_MENU_ENABLED_VERBS as i}from"./constant.js";import{floodgate as m}from"./floodgate.js";import{util as p}from"./util.js";import{viewerModuleUtils as E}from"./viewer-module-utils.js";import{common as l}from"./common.js";import{expressIndexedDBScript as u}from"../common/expressindexedDB.js";let d=!1;const g={},S=10,x=720,f="expressMenu",I={"dc-cv-express-context-menu":"EC","dc-cv-express-standalone":"EL","dc-cv-express-standalone-control":"ELC","dc-cv-express-whatsapp-preview":"EWP","dc-cv-express-whatsapp-preview-control":"EWPC"},_="cleanUpExpressAssetMemoryMap",h="cleanUpExpressIndexedDB",R=864e5,A=6e5,b={beta:["memepcobodlebmohdlfnjiaalggfcpic","hgednelcgbmkdebjhejlmbgigmkcbemg"],release:["efaidnbmnnnibpcajpcglclefindmkaj","elhekieabhbkpmcefcoobjddigjcaadp"]},T={[c.VERBS.EFFECTS_IMAGE]:"add-effects",[c.VERBS.CROP_IMAGE]:"crop-image",[c.VERBS.REMOVE_BACKGROUND_IMAGE]:"remove-background",[c.VERBS.INSERT_OBJECT]:"insert-object",[c.VERBS.REMOVE_OBJECT]:"remove-object"};async function w(e){const t=Date.now(),n=await fetch(e);if(!n.ok)throw new Error(`Response not in 2xx range. Status: ${n.statusText}`);const r=await n.blob();return new Promise(((e,n)=>{const o=new FileReader;o.readAsDataURL(r),o.onloadend=()=>{const n=o.result,r=Date.now()-t;e({base64data:n,imageDownloadTime:r})},o.onerror=n}))}async function v(e){if(!await m.hasFlag(e))return!1;const t=m.getFeatureMeta(e);if(t)try{const e=JSON.parse(t);if(e.minExtVer&&p.verCmp(e.minExtVer,chrome.runtime.getManifest().version)>0)return!1}catch(e){}return!0}function O(e){return T[e]??"edit-image"}function D(e){return(r.getItem(c.EXPRESS_SESSIONS)||{})[e]}async function L(e,t){const n=Date.now(),o=new URL(t.url).hostname,s=e.srcUrl,a=t.id,i=e.intent,m=e.touchpoint,E=await async function(){return await v("dc-cv-express-standalone")?c.VARIANT.LOE:c.VARIANT.MODAL}(),l=p.uuid(),u=r.getItem(c.EXPRESS_SESSIONS)||{};return u[l]={pageDomain:o,imageURL:s,tabId:a,intent:i,touchpoint:m,variant:E,clickTimeStamp:n},r.setItem(c.EXPRESS_SESSIONS,u),l}async function M(e,t){const n=await L(e,t);await C(n)}function P(e){const t=r.getItem(c.EXPRESS_SESSIONS)||{};return Object.keys(t).find((n=>{const o=t[n];return o.tabId===e&&!o.fetchedFromContentScript&&o.variant===c.VARIANT.MODAL&&(t[n].fetchedFromContentScript=!0,r.setItem(c.EXPRESS_SESSIONS,t),!0)}))}async function C(s){const a=D(s);let i;const m=a?.pageDomain;try{if(i=a.intent,a.variant===c.VARIANT.LOE){const e=a.clickTimeStamp,t=e+R;u.storeExpressAssetInfoInIndexedDB(s,a.imageURL,t,e),chrome.alarms.get(h,(e=>{e||chrome.alarms.create(h,{periodInMinutes:x})})),g[s]={bufferPromise:w(a.imageURL),ttl:Date.now()+A,clickTimeStamp:e,domain:m},chrome.alarms.get(_,(e=>{e||chrome.alarms.create(_,{periodInMinutes:S})}));const r=new URL(l.getExpressURLs().webAppUrl);r.searchParams.append("expressSessionId",s),r.searchParams.append("referrer",c.REFERRER);const o=O(a.intent);r.searchParams.append("editAction",o),r.searchParams.append("extId",function(){const e=Object.keys(b).filter((e=>b[e].includes(chrome.runtime.id)));return e.length>0?e[0]:"release"}());const i=n.getItem("appLocale")||p.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));r.searchParams.append("locale",i),"true"===n.getItem("adobeInternal")&&r.searchParams.append("setting-consoleLogLevel-performance","info"),chrome.tabs.create({url:r.href,active:!0})}else!function(e){let t=r.getItem(c.TAB_IDS_WHERE_MODAL_LOADING)||[];t.push(e),r.setItem(c.TAB_IDS_WHERE_MODAL_LOADING,t)}(a.tabId),await chrome.scripting.executeScript({target:{tabId:a.tabId},files:["content_scripts/express-content-script.js"]})}catch(n){V(a?.tabId,!0),e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{VERB:i,eventContext:n.toString(),expressTouchpoint:a?.touchpoint,domain:m}),o.error({message:"Error executing express verb",error:"Initiate execute verb from service worker: "+n.toString()})}}async function N(r){if(!g[r])return async function(n){let r,s,a;const i=D(n),m=await u.getExpressAssetInfoFromIndexedDB(n);if(!m)return o.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${c.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST}`}),{status:c.RESPONSE_STATUS.FAILED,errorCode:c.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST};r=m.url,s=m.clickTimeStamp;try{a=(await w(r)).base64data}catch(n){return e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:n.toString(),domain:i?.pageDomain,expressTouchpoint:i?.touchpoint}),o.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${n.toString()}`}),{status:c.RESPONSE_STATUS.FAILED,errorCode:c.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED,clickTimeStamp:s}}return{status:c.RESPONSE_STATUS.SUCCESS,buffer:a,clickTimeStamp:s}}(r);{const s=D(r)?.touchpoint,a=g[r]?.domain,i=g[r].clickTimeStamp,m=Date.now()-i;try{const{base64data:e,imageDownloadTime:t}=await g[r].bufferPromise,s=Date.now()-i;"true"===n.getItem("adobeInternal")&&(console.log("Time required to receive request from express webapp "+m),console.log("Image Download Time "+t),console.log("Time required to handover to express "+s));const p={imageDownloadTime:t,timeRequiredToHandoverToExpress:s,expressCommunicationReceivedTime:m,imageSize:e.length};return o.info({message:c.PERF_METRIC_LOG_MESSAGE,...p}),{status:c.RESPONSE_STATUS.SUCCESS,buffer:e,clickTimeStamp:i,domain:a}}catch(n){e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:n.toString(),domain:a,expressTouchpoint:s}),o.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${n.toString()}`});const r=c.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED;return{status:c.RESPONSE_STATUS.FAILED,errorCode:r,clickTimeStamp:i,domain:a}}}}function y(e){chrome.scripting.executeScript({target:{tabId:e},func:()=>{!function(e){const t=document.querySelector(`#${e}`);t?.parentElement?.removeChild(t),document.body.style.overflow="auto"}("expressAcrobatExtension"),dialogToBeReopened&&(dialogToBeReopened.showModal(),dialogToBeReopened=void 0)}})}function F(){const e=n.getItem(a);return(Array.isArray(e)?e.sort():[]).join("_")}function B(){const e=n.getItem("appLocale")||p.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale")),t="true"===n.getItem("adobeInternal"),r=n.getItem("installSource");return["en-US","en-GB"].includes(e)&&(t||"admin"!==r)}async function U(){let e=n.getItem(a)||[];const t=B();for(const n of Object.keys(I)){const r=I[n];t&&await v(n)?e.includes(r)||e.push(r):e.includes(r)&&(e=e.filter((e=>e!==r)))}e=e.filter((e=>!["Exp_Mod","Exp_Loe"].includes(e))),n.setItem(a,e)}async function j(e){const t=["http://*/*","https://*/*"];if((await k(e)).enableExpressContextMenu){if(!d){d=!0;const e=G(f,p.getTranslation("expressEditImageParentContextMenu"),["image"],t);chrome.contextMenus.create({id:"poweredByAdobeExpress",parentId:e,title:p.getTranslation("expressEditImagePoweredByExpressContextMenu"),contexts:["image"],enabled:!1,documentUrlPatterns:t}),chrome.contextMenus.create({id:"separatorForExpressMenu",parentId:e,type:"separator",contexts:["image"],documentUrlPatterns:t}),i.forEach((n=>{const r=n+"ContextMenu";G(r,p.getTranslation(r),["image"],t,e)}))}const e=await m.hasFlag("dc-cv-enable-splunk-logging",s.NO_CALL);E.enableSplunk(e)}else d&&(d=!1,chrome.contextMenus.remove("poweredByAdobeExpress"),chrome.contextMenus.remove("separatorForExpressMenu"),Object.keys(i).forEach((e=>{const t=i[e]+"ContextMenu";chrome.contextMenus.remove(t)})),chrome.contextMenus.remove(f))}async function k(r){let o={enableExpressContextMenu:!1,enableExpressOptionsPagePreference:!1,enableExpressTooltip:!1};const s=await m.hasFlag("dc-cv-express-context-menu")||await v("dc-cv-express-context-menu-ab")||await v("dc-cv-express-standalone"),a=await m.hasFlag("dc-cv-express-context-menu-tooltip"),i=await m.hasFlag("dc-cv-express-context-menu-pref-value");if(null!=r&&""!==r||null!=(r=n.getItem("express-touch-points"))&&""!==r||(r=i),await U(),s&&B()&&("true"!==n.getItem("express-context-menu-fg-enabled-analytics-logged")&&(n.setItem("express-context-menu-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_CONTEXT_MENU_FG_ENABLED)),o.enableExpressOptionsPagePreference=!0,r&&"false"!==r)){o.enableExpressContextMenu=!0;const e="true"===n.getItem(c.CONTEXT_MENU_INTERACTION_DONE);o.enableExpressTooltip=!e&&a}return o}function G(e,t,n,r,o){return chrome.contextMenus.create({id:e,parentId:o,title:t,contexts:n,documentUrlPatterns:r})}function X(n){const r=V(n);for(let n=0;n<r;n++){const n="Tab closed before express modal opened";o.error({message:"Error executing express verb",error:n}),e.event(t.EXPRESS_TAB_CLOSED_BEFORE_EXPRESS_LOADED,{eventContext:n})}}function V(e,t=!1){let n=0,o=r.getItem(c.TAB_IDS_WHERE_MODAL_LOADING)||[];return o.length>0&&o.includes(e)&&(o=o.filter((r=>{if(r===e){if(n++,t&&1===n)return!1;if(!t)return!1}return!0})),r.setItem(c.TAB_IDS_WHERE_MODAL_LOADING,o)),n}async function W(){const r={enableWhatsappPreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1},o=await m.hasFlag("dc-cv-express-whatsapp-preview"),s=await m.hasFlag("dc-cv-express-whatsapp-preview-control");let a=n.getItem("express-touch-points");return a=""===a||a,await U(),o&&B()?("true"!==n.getItem("express-whatsapp-preview-fg-enabled-analytics-logged")&&(n.setItem("express-whatsapp-preview-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_WHATSAPP_PREVIEW_MENU_FG_ENABLED)),r.enableExpressOptionsPagePreference=!0,a&&"false"!==a&&(r.enableWhatsappPreviewExpressMenu=!0)):s&&B()&&"true"!==n.getItem("express-whatsapp-preview-fg-control-enabled-analytics-logged")&&(n.setItem("express-whatsapp-preview-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_WHATSAPP_PREVIEW_MENU_FG_CONTROL_ENABLED)),r}chrome.alarms.onAlarm.addListener((function(e){e&&e.name===_&&(Object.keys(g).forEach((e=>{g[e]?.ttl<Date.now()&&delete g[e]})),0===Object.keys(g).length&&chrome.alarms.clear(_))})),chrome.alarms.onAlarm.addListener((function(e){e&&e.name===h&&u.removeExpressAssetInfoFromIndexedDB().then((()=>{u.getExpressAssetCount().then((e=>{0===e&&chrome.alarms.clear(h)}))}))}));export{C as executeExpressVerb,y as closeExpress,j as toggleExpressTouchpoints,k as isExpressContextMenuEnabled,F as getActiveExperimentAnalyticsString,N as getExpressAssetResponse,w as imageUrlToBase64,O as verbNameToIntent,V as removeTabIdFromUnloadedExpressTabs,X as expressModalTabCloseListener,W as isWhatsappPreviewExpressMenuEnabled,P as getModalSessionId,D as getExpressSession,M as launchExpress};